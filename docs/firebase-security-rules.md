# Firebase Firestore å®‰å…¨è¦å‰‡

> **å°ˆæ¡ˆåç¨±**: 2026 Happy Yuan Day  
> **Firebase å°ˆæ¡ˆ ID**: yuan-birthday-gam  
> **æœ€å¾Œæ›´æ–°æ™‚é–“**: 2025-12-06 01:17 (GMT+8)

---

## ğŸ“‹ ç›®å‰ä½¿ç”¨çš„å®Œæ•´å®‰å…¨è¦å‰‡

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. åŸºç¤è¨­å®š ---

    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ (é ç•™çµ¦æ‚¨æœªä¾†è‹¥æœ‰å¾Œå°ç®¡ç†ç”¨)
    // ç›®å‰éŠæˆ²å‰ç«¯ä¸æœƒç”¨åˆ°é€™å€‹ï¼Œä½†ä¿ç•™è‘—å¾ˆå¥½
    function isAdmin() {
      return request.auth != null && request.auth.uid in [
        'AfawV30FwqTeHvB8wbyq31kS1NE2',
        'æ‚¨çš„UID-2'
      ];
    }

    // --- 2. é›†åˆè¦å‰‡ ---

    // ğŸ† å…¨åŸŸçµ±è¨ˆè³‡æ–™ (statistics/global)
    match /statistics/global {
      // å…è¨±æ‰€æœ‰äººè®€å– (é¡¯ç¤ºåœ¨é¦–é )
      allow read: if true;

      // å…è¨±æ‰€æœ‰äººæ›´æ–° (ç‚ºäº†è®“ batch å¯«å…¥èƒ½æˆåŠŸç´¯åŠ åˆ†æ•¸)
      // é€™è£¡åŠ ä¸Šä¸€å€‹ç°¡å–®é©—è­‰ï¼šåªèƒ½æ›´æ–° totalScore ä¸”å¿…é ˆæ˜¯æ•¸å­—
      allow update: if request.resource.data.totalScore is number;

      // ç¦æ­¢åˆªé™¤é€™å€‹é‡è¦æ–‡ä»¶
      allow delete: if false;
    }

    // ğŸ“ å–®å±€åˆ†æ•¸ç´€éŒ„ (scores)
    match /scores/{scoreId} {
      allow read: if true; // å…è¨±è®€å– (è‹¥æœªä¾†åšæ’è¡Œæ¦œ)

      // å…è¨±å‰µå»ºæ–°åˆ†æ•¸ï¼Œä½†å¿…é ˆé€šéé˜²ä½œå¼Šæª¢æŸ¥
      allow create: if
        // 1. å¿…é ˆåŒ…å«å¿…è¦æ¬„ä½
        request.resource.data.keys().hasAll(['score', 'userId', 'timestamp']) &&
        // 2. åˆ†æ•¸å¿…é ˆæ˜¯æ•¸å­—
        request.resource.data.score is number &&
        // 3. ã€é˜²ä½œå¼Šã€‘å–®å±€åˆ†æ•¸ä¸Šé™è¨­å®š (ä¾‹å¦‚ 60ç§’ä¸å¤ªå¯èƒ½è¶…é 5000åˆ†)
        // æ‚¨å¯ä»¥æ ¹æ“šæ¸¬è©¦çµæœèª¿æ•´é€™å€‹æ•¸å­—ï¼Œè¨­å¯¬é¬†ä¸€é»é¿å…èª¤åˆ¤
        request.resource.data.score < 10000 &&
        // 4. ç¦æ­¢ä¸Šå‚³è² åˆ† (é›–ç„¶ç¨‹å¼ç¢¼æœ‰é˜²å‘†ï¼Œé€™è£¡å†æ“‹ä¸€æ¬¡)
        request.resource.data.score >= 0;

      // ç¦æ­¢ä¿®æ”¹æˆ–åˆªé™¤å·²ä¸Šå‚³çš„åˆ†æ•¸ (åªæœ‰ç®¡ç†å“¡å¯ä»¥)
      allow update, delete: if isAdmin();
    }

    // ğŸ‘¤ ç©å®¶å€‹äººè³‡æ–™ (players)
    match /players/{userId} {
      allow read: if true;

      // å…è¨±å‰µå»ºæˆ–æ›´æ–°å€‹äººè³‡æ–™
      // å› ç‚ºæˆ‘å€‘æ˜¯ç”¨éš¨æ©Ÿ IDï¼Œç„¡æ³•é©—è­‰èº«ä»½ï¼Œæ‰€ä»¥åªèƒ½é–‹æ”¾å¯«å…¥
      // ä½†æˆ‘å€‘å¯ä»¥é™åˆ¶è³‡æ–™çµæ§‹
      allow write: if
         request.resource.data.cumulativeScore is number;
    }
  }
}
```

---

## ğŸ”— è¦å‰‡èˆ‡ç¨‹å¼ç¢¼å°æ‡‰é—œä¿‚

### 1ï¸âƒ£ `statistics/global` é›†åˆ

**ç”¨é€”**: å„²å­˜å…¨åŸŸé‡Œç¨‹ç¢‘ç¸½åˆ†

**å°æ‡‰ç¨‹å¼ç¢¼**: `js/managers/database-manager.js`

| æ“ä½œ     | è¡Œæ•¸     | èªªæ˜                                                     |
| -------- | -------- | -------------------------------------------------------- |
| **å¯«å…¥** | L119-123 | `saveScore()` ä¸­ä½¿ç”¨ `FieldValue.increment()` ç´¯åŠ ç¸½åˆ†   |
| **è®€å–** | L189-200 | `loadTotalMilestoneScore()` è®€å–ç•¶å‰ç¸½åˆ†ä¸¦è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯” |

**è³‡æ–™çµæ§‹**:

```javascript
{
  totalScore: number,        // æ‰€æœ‰ç©å®¶ç´¯è¨ˆç¸½åˆ†
  lastUpdated: timestamp     // æœ€å¾Œæ›´æ–°æ™‚é–“
}
```

---

### 2ï¸âƒ£ `scores` é›†åˆ

**ç”¨é€”**: å„²å­˜æ¯ä¸€æ¬¡éŠæˆ²çš„åˆ†æ•¸è¨˜éŒ„

**å°æ‡‰ç¨‹å¼ç¢¼**: `js/managers/database-manager.js`

| æ“ä½œ     | è¡Œæ•¸     | èªªæ˜                             |
| -------- | -------- | -------------------------------- |
| **å»ºç«‹** | L108-116 | `saveScore()` ä¸­å»ºç«‹æ–°çš„åˆ†æ•¸æ–‡ä»¶ |

**è³‡æ–™çµæ§‹**:

```javascript
{
  userId: string,           // ç©å®¶ UID
  score: number,            // è©²å±€å¾—åˆ†
  timestamp: timestamp,     // éŠæˆ²æ™‚é–“
  version: string,          // éŠæˆ²ç‰ˆæœ¬
  stats: {                  // éŠæˆ²çµ±è¨ˆè³‡æ–™
    score: number,
    level: number,
    combo: number,
    // ... å…¶ä»–çµ±è¨ˆ
  }
}
```

---

### 3ï¸âƒ£ `players` é›†åˆ

**ç”¨é€”**: å„²å­˜ç©å®¶å€‹äººè³‡æ–™èˆ‡ç´¯è¨ˆåˆ†æ•¸

**å°æ‡‰ç¨‹å¼ç¢¼**: `js/managers/database-manager.js`

| æ“ä½œ          | è¡Œæ•¸     | èªªæ˜                                        |
| ------------- | -------- | ------------------------------------------- |
| **è®€å–**      | L65-85   | `loadPlayerProfile()` è¼‰å…¥ç©å®¶è³‡æ–™          |
| **å»ºç«‹/æ›´æ–°** | L147-171 | `saveScore()` ä¸­æ›´æ–°ç´¯è¨ˆåˆ†æ•¸å’Œæœ€å¾ŒéŠç©æ™‚é–“  |
| **æ›´æ–° IG**   | L218-227 | `saveInstagramHandle()` å„²å­˜ Instagram å¸³è™Ÿ |
| **é ˜å–çå‹µ**  | L234-248 | `claimTier()` æ›´æ–°çå‹µé ˜å–ç‹€æ…‹              |

**è³‡æ–™çµæ§‹**:

```javascript
{
  cumulativeScore: number,    // ç´¯è¨ˆç¸½åˆ†
  claimedTier1: boolean,      // æ˜¯å¦å·²é ˜å–ç¬¬ä¸€éšçå‹µ
  tier2Qualified: boolean,    // ç¬¬äºŒéšè³‡æ ¼
  tier3Qualified: boolean,    // ç¬¬ä¸‰éšè³‡æ ¼
  instagramHandle: string,    // Instagram å¸³è™Ÿ
  lastPlayed: timestamp       // æœ€å¾ŒéŠç©æ™‚é–“
}
```

---

## ğŸ›¡ï¸ å®‰å…¨æ€§èªªæ˜

### ç›®å‰è¨­è¨ˆ

- **åŒ¿åç™»å…¥**: ä½¿ç”¨ Firebase Anonymous Authentication
- **å…¬é–‹è®€å–**: æ‰€æœ‰è³‡æ–™éƒ½å¯ä»¥å…¬é–‹è®€å–ï¼ˆé©åˆæ’è¡Œæ¦œå±•ç¤ºï¼‰
- **å¯«å…¥ä¿è­·**: åªæœ‰å·²ç™»å…¥ä½¿ç”¨è€…å¯ä»¥å»ºç«‹/æ›´æ–°è³‡æ–™
- **è‡ªæˆ‘ä¿è­·**: ç©å®¶åªèƒ½ä¿®æ”¹è‡ªå·±çš„è³‡æ–™ï¼ˆé€é `request.auth.uid == userId` é©—è­‰ï¼‰

### å·²çŸ¥é™åˆ¶

âš ï¸ ç›®å‰çš„è¦å‰‡**å…è¨±åŒ¿åä½¿ç”¨è€…ç›´æ¥å¯«å…¥ `statistics/global`**ï¼Œç†è«–ä¸Šå¯èƒ½è¢«æƒ¡æ„åˆ©ç”¨ã€‚ä½†å·²é€éä¸‹æ–¹çš„ã€Œç¶²ç«™é™åˆ¶ã€é™ä½é¢¨éšªã€‚

### ğŸŒ ç¶²ç«™é™åˆ¶ (API Key Restrictions)

> âœ… å·²åœ¨ Firebase Console / Google Cloud Console è¨­å®š API Key çš„ç¶²ç«™é™åˆ¶ï¼Œåƒ…å…è¨±ä»¥ä¸‹ä¾†æºå­˜å–ï¼š

```
http://127.0.0.1:5500/*        # æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
https://2026happyyuanday.com/* # æ­£å¼ç¶²åŸŸ
https://www.2026happyyuanday.com/* # æ­£å¼ç¶²åŸŸ (www)
```

**è¨­å®šä½ç½®**: [Google Cloud Console](https://console.cloud.google.com/) â†’ APIs & Services â†’ Credentials â†’ é¸æ“‡å°æ‡‰çš„ API Key â†’ Application restrictions â†’ HTTP referrers

**æ•ˆæœ**: å³ä½¿ Firestore è¦å‰‡é–‹æ”¾å¯«å…¥ï¼Œæƒ¡æ„è€…ä¹Ÿç„¡æ³•å¾æœªæˆæ¬Šçš„ç¶²ç«™ç™¼é€ API è«‹æ±‚ï¼Œæœ‰æ•ˆé™ä½è¢«æ”»æ“Šçš„é¢¨éšªã€‚

### å»ºè­°æ”¹é€²æ–¹å‘ï¼ˆæœªä¾†è€ƒæ…®ï¼‰

1. ä½¿ç”¨ **Cloud Functions** è™•ç†åˆ†æ•¸ä¸Šå‚³ï¼Œé¿å…å®¢æˆ¶ç«¯ç›´æ¥å¯«å…¥
2. åŠ å…¥**åˆ†æ•¸é©—è­‰é‚è¼¯**ï¼Œé˜²æ­¢ç•°å¸¸é«˜åˆ†
3. é™åˆ¶**å¯«å…¥é »ç‡**ï¼Œé˜²æ­¢æ´—åˆ†è¡Œç‚º

---

## ğŸ“ æ›´æ–°æ—¥èªŒ

### 2025-12-06 01:17

- **æ–°å¢**: ç¶²ç«™é™åˆ¶ (API Key Restrictions) ç« ç¯€
- **å…§å®¹**: è¨˜éŒ„å·²åœ¨ Google Cloud Console è¨­å®šçš„ç¶²åŸŸç™½åå–®
- **å…è¨±ç¶²åŸŸ**: `127.0.0.1:5500`ã€`2026happyyuanday.com`ã€`www.2026happyyuanday.com`
- **ç›®çš„**: é…åˆæ­£å¼ä¸Šç·šï¼Œå¼·åŒ–å®‰å…¨æ€§

### 2025-12-02 17:05

- **æ–°å¢**: `statistics/global` è¦å‰‡ï¼ˆä¿®æ­£æ¬Šé™éŒ¯èª¤ï¼‰
- **åŸå› **: ç¨‹å¼ç¢¼ä½¿ç”¨äº† `statistics/global` ä½†è¦å‰‡ä¸­æœªå®šç¾©è©²è·¯å¾‘
- **éŒ¯èª¤è¨Šæ¯**: `Missing or insufficient permissions`
- **å—å½±éŸ¿åŠŸèƒ½**: é‡Œç¨‹ç¢‘ç¸½åˆ†è®€å–èˆ‡æ›´æ–°

---

## ğŸ”§ å¦‚ä½•æ›´æ–°è¦å‰‡

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)
2. é¸æ“‡å°ˆæ¡ˆï¼š**yuan-birthday-gam**
3. å·¦å´é¸å–®é¸æ“‡ **Firestore Database**
4. é»é¸é ‚éƒ¨çš„ **è¦å‰‡ (Rules)** æ¨™ç±¤
5. è²¼ä¸Šä¸Šæ–¹çš„å®Œæ•´è¦å‰‡
6. é»é¸ **ç™¼å¸ƒ (Publish)**

---

## ğŸ“Œ æ³¨æ„äº‹é …

> âš ï¸ **é‡è¦æé†’**  
> ç•¶ä¿®æ”¹ `database-manager.js` æˆ–æ–°å¢ Firestore é›†åˆ/æ–‡ä»¶æ™‚ï¼Œ**å¿…é ˆåŒæ­¥æ›´æ–°æ­¤æ–‡ä»¶å’Œ Firebase Console çš„å®‰å…¨è¦å‰‡**ï¼

**æª¢æŸ¥æ¸…å–®**:

- [ ] æ˜¯å¦æ–°å¢äº† Firestore é›†åˆï¼Ÿ
- [ ] æ˜¯å¦ä¿®æ”¹äº†è³‡æ–™çµæ§‹ï¼Ÿ
- [ ] å®‰å…¨è¦å‰‡æ˜¯å¦éœ€è¦æ–°å¢å°æ‡‰è·¯å¾‘ï¼Ÿ
- [ ] æ­¤æ–‡ä»¶æ˜¯å¦å·²æ›´æ–°ä¸¦è¨»è¨˜æ™‚é–“ï¼Ÿ
